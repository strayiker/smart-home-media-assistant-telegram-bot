#!/usr/bin/env bash
set -euo pipefail

REPO_RAW_URL_DEFAULT="https://raw.githubusercontent.com/strayiker/smart-home-media-assistant-telegram-bot/refs/heads/main"
REPO_RAW_URL="${REPO_RAW_URL:-$REPO_RAW_URL_DEFAULT}"

INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine version from repository (fallback to latest)
VERSION=$(curl -fsSL "$REPO_RAW_URL/package.json" 2>/dev/null | sed -nE 's/.*"version": "([^"]+)".*/\1/p' | head -n1 || true)
if [[ -z "${VERSION:-}" ]]; then
	VERSION="latest"
fi

IMAGE="ghcr.io/strayiker/smart-home-media-assistant-telegram-bot:${VERSION}"

echo "Updating bot image to ${IMAGE}"
docker pull "$IMAGE" || true

# Stop systemd-managed service (if present) to avoid races
if sudo systemctl list-unit-files --full --no-legend | grep -q '^smart-home-media-assistant-telegram-bot.service'; then
	echo "Stopping systemd service smart-home-media-assistant-telegram-bot.service"
	sudo systemctl stop smart-home-media-assistant-telegram-bot.service || true
fi

# Remove existing container (keeps volumes)
if docker container inspect smart-home-media-assistant-telegram-bot >/dev/null 2>&1; then
	echo "Removing existing container smart-home-media-assistant-telegram-bot"
	sudo docker rm -f smart-home-media-assistant-telegram-bot || true
fi

# Start the bot using the packaged start script (will use the pulled image tag)
if [[ -x "$INSTALL_DIR/start.sh" ]]; then
	echo "Starting bot via $INSTALL_DIR/start.sh"
	(cd "$INSTALL_DIR" && ./start.sh)
else
	echo "start.sh not found or not executable in $INSTALL_DIR; run it manually" >&2
fi

# If systemd unit exists, ensure it's enabled and running (executes start.sh via unit)
if sudo systemctl list-unit-files --full --no-legend | grep -q '^smart-home-media-assistant-telegram-bot.service'; then
	echo "Ensuring systemd service is enabled and active"
	sudo systemctl daemon-reload || true
	sudo systemctl enable --now smart-home-media-assistant-telegram-bot.service || true
fi

echo "Update complete (version: ${VERSION})."
