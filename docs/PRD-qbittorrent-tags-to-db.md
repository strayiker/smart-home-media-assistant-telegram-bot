# PRD: Убрать хранение метаданных через теги qBittorrent

## 1. Executive Summary

Текущая реализация хранит служебные метаданные бота (uid и locale) в тегах qBittorrent, что является хаком и приводит к рискам коллизий, потери данных и зависимости от внешней системы. Требуется полностью удалить использование тегов qBittorrent как хранилища метаданных и спроектировать нормальное хранение в БД. Локаль должна определяться строго из данных Telegram пользователя (по лучшим практикам grammy/Telegram) и храниться отдельно от торрента.

## 2. Контекст и мотивация

### As-is

- При добавлении торрента бот добавляет в qBittorrent теги `uid_<tracker>_<id>` и `i18n_<chatId>_<locale>`.
- При формировании сообщений и команд бот извлекает `uid` и `locale` из списка тегов торрента.
- Для команды `/ls_<uid>` и `/rm_<uid>` бот ищет торренты через фильтр `tag=uid_<uid>`.

### Проблемы

- Теги qBittorrent являются внешним хранилищем, их можно удалить или изменить вручную.
- Хранение `locale` в тегах смешивает бизнес-данные и данные UI.
- Локаль связана с торрентацией, а не с пользователем/чатом, что архитектурно неверно.
- Возможны конфликты с пользовательскими тегами в qBittorrent.
- Отсутствует централизованный контроль/миграция этих данных.

### Почему важно сейчас

- Планируется рефакторинг и расширение функциональности.
- Повышение надёжности и предсказуемости поведения бота.
- Снижение зависимости от структуры и поведения qBittorrent.

## 3. Цели и метрики успеха

| Цель                    | Метрика                                                       | Базовое значение | Целевое значение |
| ----------------------- | ------------------------------------------------------------- | ---------------- | ---------------- |
| Удалить хак с тегами    | Кол-во обращений к tag=uid\_                                  | >0               | 0                |
| Стабильность метаданных | Доля потерянных метаданных при рестарте                       | >0               | 0                |
| Ясность архитектуры     | Кол-во мест, где используется qBittorrent tags для метаданных | >1               | 0                |

## 4. Пользовательские сценарии (User Stories)

### US-1: Скачивание торрента

**Как** пользователь, **я хочу** добавить торрент командой `/dl_<uid>`, **чтобы** бот начал скачивание и отображал прогресс.

**Acceptance Criteria:**

- [ ] Метаданные о добавленном торренте сохраняются в БД.
- [ ] Прогресс и сообщения корректно отображаются после перезапуска бота.
- [ ] qBittorrent теги пользователя не перезаписываются.

### US-2: Просмотр файлов торрента

**Как** пользователь, **я хочу** вызвать `/ls_<uid>`, **чтобы** увидеть список файлов.

**Acceptance Criteria:**

- [ ] `/ls_<uid>` работает без использования `tag=uid_`.
- [ ] Ошибки при отсутствии записи в БД корректно локализованы.

### US-3: Удаление торрента

**Как** пользователь, **я хочу** вызвать `/rm_<uid>`, **чтобы** удалить торрент и файлы.

**Acceptance Criteria:**

- [ ] `/rm_<uid>` использует данные из БД.
- [ ] После удаления запись в БД удаляется/архивируется.

## 5. Функциональные требования

### FR-1

Система должна хранить служебные метаданные торрента в локальной БД (SQLite) без использования тегов qBittorrent.

### FR-2

Поиск торрента по `uid` должен выполняться через БД, а не через qBittorrent tags.

### FR-3

Локаль должна определяться по данным Telegram пользователя (`ctx.from.language_code`) и храниться в отдельной сущности настроек чата/пользователя.

### FR-4

Добавление торрента не должно создавать служебные теги в qBittorrent.

### FR-5

Формирование фоновых сообщений (без `ctx`) должно использовать сохранённую локаль чата/пользователя.

## 6. Нефункциональные требования

- Надёжность: данные не теряются при рестарте бота.
- Производительность: операции с БД не увеличивают ответ более чем на 100 мс.
- Совместимость: пользовательские теги в qBittorrent должны оставаться неизменными.
- Корректность локализации: fallback на `en` при отсутствии локали у пользователя.

## 7. Ограничения и допущения

- БД SQLite доступна и инициализируется на старте (как сейчас).
- Миграции выполняются автоматически при старте.
- В рамках задачи не меняется UI команд `/dl_`, `/ls_`, `/rm_`.
- Локаль берётся из Telegram и может обновляться при каждом входящем сообщении.

## 8. Out of Scope

- Перенос других данных qBittorrent (категории, прогресса) в БД.
- Изменение механизма авторизации.
- Переработка UX команд.

## 9. Анализ текущих сценариев использования тегов qBittorrent

### 9.1 Добавление торрента

- Теги используются как хранилище `uid` и `locale`.
- Сценарий: [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts).

### 9.2 Поиск торрента по uid

- Используется фильтр `tag=uid_<uid>`.
- Сценарий: [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts).

### 9.3 Формирование прогресс-сообщения

- `locale` и `uid` извлекаются из тегов торрента для генерации текста.
- Сценарий: [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts).

### 9.4 Непрямые зависимости

- Механизм `chatTorrents` держит хэши в памяти, но строит текст через тегированные данные.
- При рестарте метаданные берутся только из qBittorrent tags.

## 10. Открытые вопросы

| #   | Вопрос                                                     | Статус   | Решение                                                                   |
| --- | ---------------------------------------------------------- | -------- | ------------------------------------------------------------------------- |
| 1   | Нужно ли сохранять историю удалённых торрентов?            | Open     | —                                                                         |
| 2   | Нужно ли хранить `locale` на уровне пользователя или чата? | Resolved | Хранить на уровне чата (chatId), обновлять при каждом входящем сообщении. |
| 3   | Должны ли торренты восстанавливаться после рестарта по БД? | Open     | —                                                                         |

## 11. Приложения

- Текущие точки использования тегов в коде: [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts)
- Модели qBittorrent: [../src/qBittorrent/models.ts](../src/qBittorrent/models.ts)
- Типы qBittorrent: [../src/qBittorrent/types.ts](../src/qBittorrent/types.ts)
