# Implementation Plan: Перенос метаданных торрентов из qBittorrent tags в БД

**PRD:** [PRD-qbittorrent-tags-to-db.md](PRD-qbittorrent-tags-to-db.md)
**TDD:** [TDD-qbittorrent-tags-to-db.md](TDD-qbittorrent-tags-to-db.md)
**Оценка:** 3–5 человеко-дней

## Фаза 1 — Анализ и подготовка

### IP-1: Инвентаризация всех мест использования qBittorrent tags

- **Описание:** собрать список участков кода, где используются теги qBittorrent, и классифицировать их как служебные/пользовательские.
- **Файлы:**
  - [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts)
  - [../src/qBittorrent/QBittorrentClient.ts](../src/qBittorrent/QBittorrentClient.ts)
  - [../src/qBittorrent/types.ts](../src/qBittorrent/types.ts)
- **DoD:** список мест использования тегов оформлен в документе TDD.

### IP-2: Уточнение модели данных для `TorrentMeta`

- **Описание:** определить минимальный набор полей, индексы, стратегию удаления.
- **Файлы:**
  - [../src/entities/](../src/entities/)
- **DoD:** согласован список полей и индексов в TDD.

### IP-2.1: Уточнение модели данных для `ChatSettings`

- **Описание:** определить формат хранения локали и стратегию обновления.
- **Файлы:**
  - [../src/entities/](../src/entities/)
- **DoD:** согласован список полей и правила нормализации локали в TDD.

## Фаза 2 — База данных

### IP-3: Создать сущность `TorrentMeta`

- **Описание:** добавить новую сущность MikroORM.
- **Файлы:**
  - `src/entities/TorrentMeta.ts`
- **DoD:** сущность описана, компилируется, проходит lint.

### IP-4: Создать миграцию

- **Описание:** добавить миграцию для таблиц `torrent_meta` и `chat_settings`.
- **Файлы:**
  - `src/migrations/MigrationXXXXXXXX.ts`
- **DoD:** миграция корректно создаёт таблицу.

### IP-5: Обновить экспорт сущностей (если требуется)

- **Описание:** обеспечить подключение новой сущности.
- **Файлы:**
  - `src/orm.ts`
- **DoD:** ORM видит новую сущность.

## Фаза 3 — Репозиторий/сервис доступа к данным

### IP-6: Добавить сервис `TorrentMetaRepository`

- **Описание:** инкапсулировать работу с таблицей метаданных.
- **Файлы:**
  - `src/utils/TorrentMetaRepository.ts` (или аналогичный путь)
- **DoD:** есть методы `create`, `getByUid`, `getByHash`, `getByHashes`, `remove`.

### IP-7: Unit-тесты репозитория (если предусмотрено)

- **Описание:** добавить тесты базовых операций.
- **Файлы:**
  - `src/**/__tests__/TorrentMetaRepository.test.ts`
- **DoD:** тесты проходят локально.

### IP-7.1: Добавить сервис `ChatSettingsRepository`

- **Описание:** инкапсулировать работу с таблицей локали чата.
- **Файлы:**
  - `src/utils/ChatSettingsRepository.ts`
- **DoD:** есть методы `upsertLocale`, `getLocale`.

### IP-7.2: Добавить middleware сохранения локали

- **Описание:** при каждом апдейте сохранять локаль пользователя в `ChatSettings`.
- **Файлы:**
  - [../src/index.ts](../src/index.ts)
- **DoD:** локаль сохраняется из `ctx.from.language_code`, fallback на `en`.

## Фаза 4 — Рефакторинг бизнес-логики

### IP-8: Обновить добавление торрента

- **Описание:** при `/dl_` сохранять метаданные в БД; убрать теги.
- **Файлы:**
  - [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts)
- **DoD:** теги `uid_` и `i18n_` больше не создаются.

### IP-9: Переписать `getTorrentByUid`

- **Описание:** искать `hash` через БД, а не через `tag=uid_`.
- **Файлы:**
  - [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts)
- **DoD:** команда `/ls_` и `/rm_` используют БД.

### IP-10: Обновить `formatTorrent`

- **Описание:** получать `uid` из `TorrentMeta`, а `locale` — из `ChatSettings` по `chatId`.
- **Файлы:**
  - [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts)
- **DoD:** сообщения используют БД, fallback на `en`.

### IP-11: Обновить обработку завершённых торрентов

- **Описание:** удалить метаданные после удаления торрента.
- **Файлы:**
  - [../src/composers/TorrentsComposer.ts](../src/composers/TorrentsComposer.ts)
- **DoD:** записи в БД не остаются «висячими».

## Фаза 5 — Локализация и сообщения

### IP-12: Добавить новые локализации ошибок БД

- **Описание:** сообщения на случаи отсутствия метаданных.
- **Файлы:**
  - [../locales/](../locales/)
- **DoD:** все локали содержат новые ключи.

## Фаза 6 — Тестирование и стабилизация

### IP-13: Ручные проверки

- **Описание:** прогон сценариев /dl, /ls, /rm, рестарт бота.
- **DoD:** все сценарии успешны.

### IP-14: Рефакторинг и очистка

- **Описание:** убрать остаточные комментарии про теги.
- **DoD:** код не содержит `uid_` и `i18n_` тегов.

## Порядок выполнения (Dependency Graph)

IP-1 → IP-2 → IP-2.1 → IP-3 → IP-4 → IP-5 → IP-6 → IP-7.1 → IP-7.2 → IP-8 → IP-9 → IP-10 → IP-11 → IP-12 → IP-13 → IP-14

## Риски реализации

| Задача | Риск                           | Митигация              |
| ------ | ------------------------------ | ---------------------- |
| IP-8   | Ошибки при добавлении торрента | транзакции/rollback    |
| IP-10  | Отсутствие метаданных          | fallback + логирование |

## Критерии завершения фичи

- [ ] Ни один участок кода не использует qBittorrent tags для метаданных.
- [ ] Все сценарии `/dl_`, `/ls_`, `/rm_` работают.
- [ ] Локаль берётся из Telegram данных и хранится отдельно от торрентов.
- [ ] Тесты и ручные проверки пройдены.
